name: Selenium Manual Scaling (16GB Runner)

on:
  workflow_dispatch:
    inputs:
      suite_name:
        description: 'Target TestNG XML'
        required: true
        type: choice
        options:
          - regression-suites.xml
          - sanity-suites.xml
      test_env:
        description: 'Execution Environment'
        required: true
        default: 'qa'
        type: choice
        options: [qa, dev, stage, uat, prod]
      node_count:
        description: 'Manual Browser Count (Max 14 recommended)'
        required: true
        default: '14'

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. CLUSTER SETUP
      - name: Setup K8s (Kind) with Retry
        run: |
          for i in {1..3}; do
            kind create cluster --name selenium-grid --wait 300s && break || {
              kind delete cluster --name selenium-grid
              sleep 10
            }
          done

      # 2. VALIDATE CAPACITY
      - name: Determine Browser Capacity
        id: hardware
        run: |
          USER_REQ=${{ github.event.inputs.node_count }}
          # Limit to 14 for stability on 4-core machine
          [ "$USER_REQ" -gt 14 ] && FINAL=14 || FINAL=$USER_REQ
          echo "nodes=$FINAL" >> $GITHUB_OUTPUT

      # 3. DEPLOY GRID
      - name: Deploy Selenium Grid
        run: |
          REPLICAS=${{ steps.hardware.outputs.nodes }}
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: selenium-hub
          spec:
            ports:
              - {name: hub, port: 4444}
              - {name: pub, port: 4442}
              - {name: sub, port: 4443}
            selector: {app: selenium-hub}
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-hub
          spec:
            replicas: 1
            selector: {matchLabels: {app: selenium-hub}}
            template:
              metadata: {labels: {app: selenium-hub}}
              spec:
                containers:
                - name: selenium-hub
                  image: selenium/hub:4.16.1
                  resources: {requests: {cpu: "500m", memory: "1Gi"}}
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: selenium-node-chrome
          spec:
            replicas: $REPLICAS
            selector: {matchLabels: {app: selenium-node-chrome}}
            template:
              metadata: {labels: {app: selenium-node-chrome}}
              spec:
                containers:
                - name: selenium-node-chrome
                  image: selenium/node-chrome:130.0
                  env:
                  - {name: SE_EVENT_BUS_HOST, value: selenium-hub}
                  - {name: SE_EVENT_BUS_PUBLISH_PORT, value: "4442"}
                  - {name: SE_EVENT_BUS_SUBSCRIBE_PORT, value: "4443"}
                  - {name: SE_NODE_MAX_SESSIONS, value: "1"}
                  volumeMounts: [{name: dshm, mountPath: /dev/shm}]
                volumes: [{name: dshm, emptyDir: {medium: Memory, sizeLimit: "2Gi"}}]
          EOF

      # 4. EXECUTION
      - name: Run Maven
        run: |
          kubectl rollout status deployment/selenium-node-chrome --timeout=300s
          kubectl port-forward service/selenium-hub 4444:4444 > pf.log 2>&1 &
          timeout 120s bash -c 'until curl -s http://localhost:4444/status | grep "\"ready\": true"; do sleep 5; done'
          
          mvn test -DsuiteXmlFile=src/test/resources/${{ github.event.inputs.suite_name }} \
                   -DthreadCount=${{ steps.hardware.outputs.nodes }} \
                   -Denv=${{ github.event.inputs.test_env }} \
                   -Dremote=true \
                   -Dhuburl=http://localhost:4444/wd/hub

      # 5. REPORTING
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Results-Browsers-${{ steps.hardware.outputs.nodes }}
          path: |
            target/surefire-reports/
            target/chaintest/
            allure-results/

      - name: Cleanup
        if: always()
        run: kind delete cluster --name selenium-grid || true
